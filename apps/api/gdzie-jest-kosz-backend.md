# Gdzie Jest Kosz - Backend Documentation

This document describes the technical details of the "Gdzie Jest Kosz" application backend.

## 1. Project Description

The backend for the "Gdzie Jest Kosz" mobile application, which helps users, particularly dog owners, locate nearby trash bins, especially for pet waste.

## 2. Technology Stack

- **Backend Framework**: NestJS
- **Language**: TypeScript
- **Database**: MySQL (as per .cursorrules)
- **ORM**: Prisma
- **Authentication**: Clerk (as per .cursorrules)
- **Geolocation**: Manages and serves geolocation data.

## 3. Project Structure

(This section will describe the general directory and module structure of the project)

- `src/`: Main directory with the application's source code.
  - `main.ts`: Application entry point file.
  - `app.module.ts`: Main application module.
  - (Other modules and components)
- `prisma/`: Contains the Prisma database schema (`schema.prisma`) and migrations.
  - `schema.prisma`: Defines the database schema.
- `test/`: Unit and integration tests (Jest).

## 4. Database Schema

This section details the database schema based on `prisma/schema.prisma`.

```prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Bin {
  id          Int       @id @default(autoincrement())
  type        String
  latitude    Decimal   @db.Decimal(18, 14)
  longitude   Decimal   @db.Decimal(18, 14)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  acceptedAt  DateTime?
  createdById Int?
  createdBy   User?     @relation(fields: [createdById], references: [id])

  @@index([createdById], map: "Bin_createdById_fkey")
}

model User {
  id      Int     @id @default(autoincrement())
  clerkId String  @unique
  role    String? @default("user")
  bins    Bin[]
}
```

### Tables

#### `Bin`

Stores information about trash bins.

- `id` (Int, Primary Key, Auto-increment): Unique identifier for the bin.
- `type` (String): Type of the bin (e.g., "general", "pet_waste").
- `latitude` (Decimal): Latitude of the bin's location.
- `longitude` (Decimal): Longitude of the bin's location.
- `createdAt` (DateTime): Timestamp of when the bin record was created.
- `updatedAt` (DateTime): Timestamp of the last update to the bin record.
- `deletedAt` (DateTime, Nullable): Timestamp of when the bin record was soft-deleted.
- `acceptedAt` (DateTime, Nullable): Timestamp of when the bin was reviewed and accepted.
- `createdById` (Int, Nullable, Foreign Key): ID of the user who created the bin record.
- `createdBy` (User, Nullable, Relation): Relation to the `User` who created the bin.

#### `User`

Stores information about application users.

- `id` (Int, Primary Key, Auto-increment): Unique identifier for the user.
- `clerkId` (String, Unique): Unique identifier from Clerk authentication service.
- `role` (String, Nullable, Default: "user"): Role of the user (e.g., "user", "admin").
- `bins` (Bin[], Relation): List of bins created by the user.

### Relationships

- A `User` can create multiple `Bin` records (one-to-many). Each `Bin` is created by one `User` (or null if created anonymously/system).

## 5. Database Migrations

(This section will list and describe database migrations generated by Prisma Migrate)

- No migrations have been generated yet as the `prisma/migrations` directory does not exist.

## 6. API Endpoints

This section outlines the available API endpoints. For detailed request/response schemas and to try out the API, please refer to the Swagger documentation available at `/api` (or your configured Swagger path) when the application is running.

### Bins (`/v1/bins`)

- **`GET /`**: Get nearby bins.

  - Query Parameters:
    - `latitude` (number, required): User's current latitude.
    - `longitude` (number, required): User's current longitude.
  - Response: Array of `Bin` objects.

- **`POST /`**: Create a new bin (requires authentication).

  - Request Body: `{ "latitude": number, "longitude": number }`
  - Response: The created `Bin` object.

- **`GET /admin`**: Get all nearby bins for a location (admin only, requires authentication).

  - Query Parameters:
    - `latitude` (number, required): Latitude for the center of the search area.
    - `longitude` (number, required): Longitude for the center of the search area.
  - Response: Array of `Bin` objects, including those not yet accepted.

- **`POST /admin`**: Create a new bin as an admin (requires authentication).

  - Request Body: `{ "latitude": number, "longitude": number }`
  - Response: The created `Bin` object (automatically accepted).

- **`PUT /admin/:binId/location`**: Update a bin's location (admin only, requires authentication).

  - Path Parameter: `binId` (number, required): ID of the bin to update.
  - Request Body: `{ "latitude": number, "longitude": number }`
  - Response: The updated `Bin` object.

- **`PUT /admin/:binId/accept`**: Accept or reject a bin (admin only, requires authentication).
  - Path Parameter: `binId` (number, required): ID of the bin to update.
  - Request Body (`AcceptBinDto`): `{ "accept": boolean }`
    - `accept` (boolean, required): `true` to mark the bin as accepted (sets `acceptedAt` to current time), `false` to mark as not accepted (sets `acceptedAt` to `null`).
  - Response: The updated `Bin` object.

## 7. Environment Configuration

(Description of environment variables and application configuration methods)

## 8. Running the Project

### Prerequisites

- Node.js (specify version, e.g., >=18.x)
- npm/yarn
- Docker (optional, if used for the database)

### Steps

1.  Clone the repository.
2.  Install dependencies: `npm install` or `yarn install`.
3.  Configure environment variables (create a `.env` file, possibly from an `.env.example`).
4.  Run Prisma migrations: `npx prisma migrate dev`.
5.  Start the application in development mode: `npm run start:dev`.

The application will be available at `http://localhost:3000` (default for NestJS).

## 9. Tests

- Run all tests: `npm run test`
- Run E2E tests: `npm run test:e2e`

## 10. Contribution Guidelines

- **Branching**: Feature-based branching.
- **Commit Messages**: Concise and descriptive.
- **Code Style**: Adhere to Prettier and ESLint configurations in the project.

---

_This documentation will be regularly updated as the project evolves._
